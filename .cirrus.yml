container:
  image: node:20 # 建议使用包含浏览器的镜像，如 buildkite/puppeteer

monitor_task:
  # 定时任务建议在 Cirrus CI 控制台 "Scheduled Tasks" 中配置
  
  container: # 也可以用 container: 、arm_container 来指定
    image: node:20
    cpu: 1
    memory: 2G

  # 环境变量 (Secrets 需要在 Cirrus 控制台加密后替换)
  env:
    CF_API_URL: ENCRYPTED[!3bab141ad9bcf5143bb1bf072f0945bcd9032c0c4877feac224bb08504d42ae06f95719f6bae32f619f7866b93c79bf0!]
#    CF_API_KEY: ENCRYPTED[xxx]
#    NODE_NAME: ENCRYPTED[xxx]
    MAIN: ENCRYPTED[!12336b1e63fb0f496c6fe7afc6fee12e2fba0c28c4e3017d4eb8caa0103dcb8c6cca94b95389328b2d95df02f394ee00!]
#    RELEASE: ENCRYPTED[xxx]
#    CIRRUS_TOKEN: ENCRYPTED[xxx] # 对应 GITHUB_TOKEN

  # 缓存程序与字体
  node_modules_cache:
    folder: node_modules
    fingerprint_script: cat package.json
    reupload_on_changes: true

  puppeteer_cache:
    folders: 
      - ~/.cache/puppeteer
      - ~/.local/share/fonts
      - release_tracking_cache
    fingerprint_key: v6-${CIRRUS_OS}
    
  resource_cache:
    folder: resource_cache
    fingerprint_key: res-${CIRRUS_BUILD_ID} # 模拟 run_id

  install_script:
    - mkdir -p ~/.local/share/fonts
    - apt-get update -qq && apt-get install -y fonts-wqy-microhei fonts-noto-cjk
    - fc-cache -fv
    - npm install puppeteer-core puppeteer-extra puppeteer-extra-plugin-adblocker croner @octokit/rest axios fs-extra

  run_script:
    - echo "$MAIN" > main.js
    - node main.js