task:
  name: CI
  allow_manual_trigger: true
#  trigger:
#    cron: "0,10,20,30,40,50 * * * *"

  container:
    #image: node:20
    #cpu: 1
    #memory: 2G
    # 关键修正：切换至 CircleCI 官方 Node+Chrome 镜像
    # 优势：预装 Chrome/Node，包含 sudo，权限配置完善，安全可靠
    image: cimg/node:20-browsers
    cpu: 2
    memory: 4G
    
  env:
    PUPPETEER_CACHE_DIR: $CIRRUS_WORKING_DIR/.cache/puppeteer
    CF_API_URL: "ENCRYPTED[1f275076ca9517c74bb796d31b213a919f4872c0d13495c7bf3282882b0c0231b155dc464fdf55a062c1b2a8dea276d8]"
    MAIN: "ENCRYPTED[0754a2039228f49879374e6a2822d154afdd98cd355079e43519072d79e78a5c36f8e8c255ed700ed2b5d8061d8745df]"
#    RELEASE: ENCRYPTED[xxx]
#    GITHUB_TOKEN: ENCRYPTED[xxx]
#    CF_API_KEY: ENCRYPTED[xxx]
#    NODE_NAME: ENCRYPTED[xxx]

  # 统一缓存到当前目录下的 .cache 和 node_modules
  all_cache:
    folders:
      - .cache
      - node_modules
      - resource_cache
#      - release_tracking_cache
    #fingerprint_key: v2-all-cache
    fingerprint_key: v6-cimg-cache
    reupload_on_changes: true

  setup_script:
    # 1. 路径修复：该镜像有 sudo 权限，可成功创建软链接
    # 该镜像 Chrome 位于 /opt/google/chrome/google-chrome，需链接为代码预期的 /usr/bin/google-chrome
    - sudo ln -sf /opt/google/chrome/google-chrome /usr/bin/google-chrome
    - mkdir -p .cache/fonts
    - |
      if [ ! -f ".cache/fonts/.fonts_installed" ]; then
        echo ">>> 首次运行，安装字体..."
        sudo apt-get update -qq && sudo apt-get install -y fonts-wqy-microhei fonts-noto-cjk
        cp -r /usr/share/fonts/truetype/wqy/* .cache/fonts/ 2>/dev/null || true
        cp -r /usr/share/fonts/opentype/noto/* .cache/fonts/ 2>/dev/null || true
        touch .cache/fonts/.fonts_installed
      else
        echo ">>> 利用缓存恢复字体..."
        sudo mkdir -p /usr/share/fonts/truetype/wqy
        sudo cp .cache/fonts/* /usr/share/fonts/truetype/wqy/ 2>/dev/null || true
        sudo fc-cache -fv
      fi
    #检测到字体缓存缺失，开始安装...
    #E: Could not open lock file /var/lib/apt/lists/lock - open (13: Permission denied)
    #E: Unable to lock directory /var/lib/apt/lists/
 
  install_script:
    - npm install puppeteer-core puppeteer-extra puppeteer-extra-plugin-adblocker croner @octokit/rest axios fs-extra

  run_script:
    - mkdir -p resource_cache
    - find . -name google-chrome
    - find . -name google-chrome-stable
    #- printenv MAIN > main2.js
    #- cat main2.js 
    #- node -e 'require("fs").writeFileSync("main.js", process.env.MAIN)'
    - node -e "require('fs').writeFileSync('main.js', Buffer.from(process.env.MAIN, 'base64').toString('utf8'))"
    #- cat main.js 
    - node main.js
    - find . -name resource_cache
    - find . -name node_modules